---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.5
  name: qscalers.qscaler.qubex.ai
spec:
  group: qscaler.qubex.ai
  names:
    kind: QScaler
    listKind: QScalerList
    plural: qscalers
    singular: qscaler
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.active
      name: Active
      type: boolean
    - jsonPath: .status.qNodeStatuses[?(@.phase == 'Hibernated')].count
      name: Hibernated
      type: integer
    - jsonPath: .status.qNodeStatuses[?(@.phase == 'Running')].count
      name: Running
      type: integer
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          QScaler is the entity responsible of making sure that a nodepool gets new VMs ASAP when
          pressure is detected
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            properties:
              active:
                description: Whether the scaler is active and should create a corresponding
                  QBaker
                type: boolean
              minimumQNodes:
                description: The minimum number of QNodes that the scaler should maintain
                format: int32
                type: integer
              minimumResourcesPerNode:
                description: Minimum Resources per single node needed to protect related
                  workloads so that the QNode will be larger than an individual pod
                  it protects
                properties:
                  cpu:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  memory:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                type: object
              overrides:
                description: The overrides for the scaler
                properties:
                  instanceTypes:
                    items:
                      type: string
                    type: array
                  maxHibernatedQNodes:
                    properties:
                      type:
                        description: The type of the restriction
                        enum:
                        - Absolute
                        - PercentOfPool
                        - PercentOfRunning
                        type: string
                      value:
                        description: The value of the restriction
                        format: int32
                        type: integer
                    required:
                    - type
                    - value
                    type: object
                  maxRunningQNodes:
                    properties:
                      type:
                        description: The type of the restriction
                        enum:
                        - Absolute
                        - PercentOfPool
                        - PercentOfRunning
                        type: string
                      value:
                        description: The value of the restriction
                        format: int32
                        type: integer
                    required:
                    - type
                    - value
                    type: object
                type: object
              resources:
                description: Resources needed to protect related workloads
                properties:
                  cpu:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  memory:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                type: object
              targetNodepool:
                description: The object that the scaler is in charge of scaling, currently
                  only ASG and Karpenter are supported
                properties:
                  castAINodeTemplateTarget:
                    description: Reference for the nodegroup if it's of type CastAINodeTemplate
                    properties:
                      nodeTemplateName:
                        description: The name of the node template to be shadowed
                        type: string
                    required:
                    - nodeTemplateName
                    type: object
                  clusterAutoscalerTarget:
                    description: Reference for the nodegroup if it's of type ClusterAutoscalerASG
                    properties:
                      asgName:
                        description: The name of the ASG to be shadowed
                        type: string
                    required:
                    - asgName
                    type: object
                  karpenterB1Target:
                    description: Reference for the nodegroup if it's of type KarpenterB1Target
                    properties:
                      nodePoolName:
                        description: The name of the nodepool to be shadowed
                        type: string
                    required:
                    - nodePoolName
                    type: object
                  karpenterV1Target:
                    description: Reference for the nodegroup if it's of type KarpenterV1Target
                    properties:
                      nodePoolName:
                        description: The name of the nodepool to be shadowed
                        type: string
                    required:
                    - nodePoolName
                    type: object
                  nodegroupName:
                    description: Nodegroup name
                    type: string
                  spotVNGTarget:
                    description: Reference for the nodegroup if it's of type SpotVNGTarget
                    properties:
                      launchSpecID:
                        description: The launch spec ID
                        type: string
                      oceanId:
                        description: The ocean ID
                        type: string
                    required:
                    - launchSpecID
                    - oceanId
                    type: object
                  staticTarget:
                    description: Reference for the nodegroup if it's of type StaticNodegroup
                    properties:
                      awsNodeGroupParams:
                        description: |-
                          A little bit of a hack: a static target means we configure everything manually
                          so, copy the Infra params and node params to the qscaler params
                        properties:
                          AMIs:
                            description: AMI details for the underlying VMs
                            items:
                              properties:
                                architecture:
                                  description: Architecture of the AMI
                                  enum:
                                  - AMD64
                                  - ARM64
                                  type: string
                                deviceMappings:
                                  additionalProperties:
                                    properties:
                                      deviceName:
                                        type: string
                                      sizeGB:
                                        format: int32
                                        type: integer
                                      type:
                                        type: string
                                    type: object
                                  description: The device mapping entries associated
                                    with this target
                                  type: object
                                imageID:
                                  description: The AWS AIM ID to be used for the underlying
                                    VMs
                                  type: string
                                rootVolumeName:
                                  description: The AWS root volume name to be applied
                                    to the underlying VM
                                  type: string
                              type: object
                            type: array
                          allowedInstanceTypes:
                            description: The AWS instance types that are allowed by
                              the upstream nodepool definition
                            items:
                              type: string
                            type: array
                          availabilityZones:
                            description: The availability zones associated with this
                              target
                            items:
                              type: string
                            type: array
                          iamInstanceProfileArn:
                            description: The IAM instance profile to be used for the
                              underlying VMs
                            type: string
                          imdsMaxHopCount:
                            description: The IMDS max hop count to be used for the
                              underlying VMs
                            format: int32
                            type: integer
                          imdsVersion:
                            description: The IMDS version to be used for the underlying
                              VMs
                            type: string
                          securityGroupIds:
                            description: The security groups associated with this
                              target
                            items:
                              type: string
                            type: array
                          subnets:
                            description: |-
                              The AWS key pair to be used for the underlying VMs
                              The tags associated with this target
                              TemplateTags     map[string]string `json:"templateTags,omitempty"`
                              The active AWS subnets for this target
                            items:
                              type: string
                            type: array
                        type: object
                    type: object
                  type:
                    description: The type of the target
                    enum:
                    - ClusterAutoscalerASG
                    - KarpenterNodepoolB1
                    - KarpenterNodepoolV1
                    - SpotVNG
                    - StaticNodegroup
                    - CastAINodeTemplate
                    type: string
                  upstreamCloudName:
                    description: Upstream cloud name
                    type: string
                required:
                - type
                type: object
            required:
            - active
            - minimumQNodes
            - minimumResourcesPerNode
            - overrides
            - resources
            - targetNodepool
            type: object
          status:
            properties:
              infraParams:
                description: The active infra parameters
                properties:
                  aws:
                    description: the infra params for AWS
                    properties:
                      AMIs:
                        description: AMI details for the underlying VMs
                        items:
                          properties:
                            architecture:
                              description: Architecture of the AMI
                              enum:
                              - AMD64
                              - ARM64
                              type: string
                            deviceMappings:
                              additionalProperties:
                                properties:
                                  deviceName:
                                    type: string
                                  sizeGB:
                                    format: int32
                                    type: integer
                                  type:
                                    type: string
                                type: object
                              description: The device mapping entries associated with
                                this target
                              type: object
                            imageID:
                              description: The AWS AIM ID to be used for the underlying
                                VMs
                              type: string
                            rootVolumeName:
                              description: The AWS root volume name to be applied
                                to the underlying VM
                              type: string
                          type: object
                        type: array
                      allowedInstanceTypes:
                        description: The AWS instance types that are allowed by the
                          upstream nodepool definition
                        items:
                          type: string
                        type: array
                      availabilityZones:
                        description: The availability zones associated with this target
                        items:
                          type: string
                        type: array
                      iamInstanceProfileArn:
                        description: The IAM instance profile to be used for the underlying
                          VMs
                        type: string
                      imdsMaxHopCount:
                        description: The IMDS max hop count to be used for the underlying
                          VMs
                        format: int32
                        type: integer
                      imdsVersion:
                        description: The IMDS version to be used for the underlying
                          VMs
                        type: string
                      securityGroupIds:
                        description: The security groups associated with this target
                        items:
                          type: string
                        type: array
                      subnets:
                        description: |-
                          The AWS key pair to be used for the underlying VMs
                          The tags associated with this target
                          TemplateTags     map[string]string `json:"templateTags,omitempty"`
                          The active AWS subnets for this target
                        items:
                          type: string
                        type: array
                    type: object
                  type:
                    description: the infra params type - only AWS is supported for
                      now
                    enum:
                    - AWS
                    type: string
                required:
                - type
                type: object
              maxRunningQNodes:
                default: 0
                description: The maximum number of QNodes that the scaler can resume
                format: int32
                type: integer
              nodeParams:
                description: The active node parameters
                properties:
                  annotations:
                    additionalProperties:
                      type: string
                    description: The node annotations associated with this target
                    type: object
                  labels:
                    additionalProperties:
                      maxLength: 63
                      type: string
                    description: labels associated with this target
                    type: object
                  limits:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: The maximum capacity associated with this target
                    type: object
                  requirements:
                    description: The node requirements associated with this target
                    items:
                      description: |-
                        A node selector requirement is a selector that contains values, a key, and an operator
                        that relates the key and values.
                      properties:
                        key:
                          description: The label key that the selector applies to.
                          type: string
                        operator:
                          description: |-
                            Represents a key's relationship to a set of values.
                            Valid operators are In, NotIn, Exists, DoesNotExist. Gt, and Lt.
                          type: string
                        values:
                          description: |-
                            An array of string values. If the operator is In or NotIn,
                            the values array must be non-empty. If the operator is Exists or DoesNotExist,
                            the values array must be empty. If the operator is Gt or Lt, the values
                            array must have a single element, which will be interpreted as an integer.
                            This array is replaced during a strategic merge patch.
                          items:
                            type: string
                          type: array
                          x-kubernetes-list-type: atomic
                      required:
                      - key
                      - operator
                      type: object
                    type: array
                  startupTaints:
                    description: The node startup taints associated with this target
                    items:
                      description: |-
                        The node this Taint is attached to has the "effect" on
                        any pod that does not tolerate the Taint.
                      properties:
                        effect:
                          description: |-
                            Required. The effect of the taint on pods
                            that do not tolerate the taint.
                            Valid effects are NoSchedule, PreferNoSchedule and NoExecute.
                          type: string
                        key:
                          description: Required. The taint key to be applied to a
                            node.
                          type: string
                        timeAdded:
                          description: |-
                            TimeAdded represents the time at which the taint was added.
                            It is only written for NoExecute taints.
                          format: date-time
                          type: string
                        value:
                          description: The taint value corresponding to the taint
                            key.
                          type: string
                      required:
                      - effect
                      - key
                      type: object
                    type: array
                  taints:
                    description: The node taints associated with this target
                    items:
                      description: |-
                        The node this Taint is attached to has the "effect" on
                        any pod that does not tolerate the Taint.
                      properties:
                        effect:
                          description: |-
                            Required. The effect of the taint on pods
                            that do not tolerate the taint.
                            Valid effects are NoSchedule, PreferNoSchedule and NoExecute.
                          type: string
                        key:
                          description: Required. The taint key to be applied to a
                            node.
                          type: string
                        timeAdded:
                          description: |-
                            TimeAdded represents the time at which the taint was added.
                            It is only written for NoExecute taints.
                          format: date-time
                          type: string
                        value:
                          description: The taint value corresponding to the taint
                            key.
                          type: string
                      required:
                      - effect
                      - key
                      type: object
                    type: array
                type: object
              protectedWorkloadReferences:
                description: Protected workload references
                items:
                  properties:
                    name:
                      description: Name
                      type: string
                    namespace:
                      description: Namespace
                      type: string
                  required:
                  - name
                  - namespace
                  type: object
                type: array
              qBakerTemplate:
                description: The parameters for the baker that the scaler is managing,
                  unused if spec.sourceQBaker is set
                properties:
                  spec:
                    description: The spec of the baker
                    properties:
                      aws:
                        description: The AWS specific configuration for the node
                        properties:
                          AMIs:
                            description: AMI details for the underlying VMs
                            items:
                              properties:
                                architecture:
                                  description: Architecture of the AMI
                                  enum:
                                  - AMD64
                                  - ARM64
                                  type: string
                                deviceMappings:
                                  additionalProperties:
                                    properties:
                                      deviceName:
                                        type: string
                                      sizeGB:
                                        format: int32
                                        type: integer
                                      type:
                                        type: string
                                    type: object
                                  description: The device mapping entries associated
                                    with this target
                                  type: object
                                imageID:
                                  description: The AWS AIM ID to be used for the underlying
                                    VMs
                                  type: string
                                rootVolumeName:
                                  description: The AWS root volume name to be applied
                                    to the underlying VM
                                  type: string
                              type: object
                            type: array
                          imdsMaxHopCount:
                            description: Imds max hop count
                            format: int32
                            type: integer
                          imdsVersion:
                            description: Imds version
                            type: string
                          instanceProfileArn:
                            description: Instance profile arn
                            type: string
                          securityGroupIds:
                            description: The security groups to be applied to the
                              underlying VM
                            items:
                              type: string
                            type: array
                          zoneDetails:
                            additionalProperties:
                              properties:
                                subnetIds:
                                  description: The subnet id that will be used for
                                    the QNodes in the zone
                                  items:
                                    type: string
                                  type: array
                              type: object
                            description: A map containing zone specific details for
                              all zones covered by the QScaler
                            type: object
                        type: object
                      instanceTypeConfigurations:
                        description: The instance type configurations for the baker
                        items:
                          properties:
                            desiredNodeCount:
                              description: The desired nodes the baker should bake
                              format: int32
                              type: integer
                            instanceType:
                              description: The instance type in the corresponding
                                cloud provider
                              type: string
                          required:
                          - desiredNodeCount
                          - instanceType
                          type: object
                        type: array
                      labels:
                        additionalProperties:
                          maxLength: 63
                          type: string
                        description: The node labels to be applied to the node
                        type: object
                      taints:
                        description: The node taints to be applied to the node
                        items:
                          description: |-
                            The node this Taint is attached to has the "effect" on
                            any pod that does not tolerate the Taint.
                          properties:
                            effect:
                              description: |-
                                Required. The effect of the taint on pods
                                that do not tolerate the taint.
                                Valid effects are NoSchedule, PreferNoSchedule and NoExecute.
                              type: string
                            key:
                              description: Required. The taint key to be applied to
                                a node.
                              type: string
                            timeAdded:
                              description: |-
                                TimeAdded represents the time at which the taint was added.
                                It is only written for NoExecute taints.
                              format: date-time
                              type: string
                            value:
                              description: The taint value corresponding to the taint
                                key.
                              type: string
                          required:
                          - effect
                          - key
                          type: object
                        type: array
                      target:
                        description: The target to which QNodes should be added
                        properties:
                          castAINodeTemplateTarget:
                            description: Reference for the nodegroup if it's of type
                              CastAINodeTemplate
                            properties:
                              nodeTemplateName:
                                description: The name of the node template to be shadowed
                                type: string
                            required:
                            - nodeTemplateName
                            type: object
                          clusterAutoscalerTarget:
                            description: Reference for the nodegroup if it's of type
                              ClusterAutoscalerASG
                            properties:
                              asgName:
                                description: The name of the ASG to be shadowed
                                type: string
                            required:
                            - asgName
                            type: object
                          karpenterB1Target:
                            description: Reference for the nodegroup if it's of type
                              KarpenterB1Target
                            properties:
                              nodePoolName:
                                description: The name of the nodepool to be shadowed
                                type: string
                            required:
                            - nodePoolName
                            type: object
                          karpenterV1Target:
                            description: Reference for the nodegroup if it's of type
                              KarpenterV1Target
                            properties:
                              nodePoolName:
                                description: The name of the nodepool to be shadowed
                                type: string
                            required:
                            - nodePoolName
                            type: object
                          nodegroupName:
                            description: Nodegroup name
                            type: string
                          spotVNGTarget:
                            description: Reference for the nodegroup if it's of type
                              SpotVNGTarget
                            properties:
                              launchSpecID:
                                description: The launch spec ID
                                type: string
                              oceanId:
                                description: The ocean ID
                                type: string
                            required:
                            - launchSpecID
                            - oceanId
                            type: object
                          staticTarget:
                            description: Reference for the nodegroup if it's of type
                              StaticNodegroup
                            properties:
                              awsNodeGroupParams:
                                description: |-
                                  A little bit of a hack: a static target means we configure everything manually
                                  so, copy the Infra params and node params to the qscaler params
                                properties:
                                  AMIs:
                                    description: AMI details for the underlying VMs
                                    items:
                                      properties:
                                        architecture:
                                          description: Architecture of the AMI
                                          enum:
                                          - AMD64
                                          - ARM64
                                          type: string
                                        deviceMappings:
                                          additionalProperties:
                                            properties:
                                              deviceName:
                                                type: string
                                              sizeGB:
                                                format: int32
                                                type: integer
                                              type:
                                                type: string
                                            type: object
                                          description: The device mapping entries
                                            associated with this target
                                          type: object
                                        imageID:
                                          description: The AWS AIM ID to be used for
                                            the underlying VMs
                                          type: string
                                        rootVolumeName:
                                          description: The AWS root volume name to
                                            be applied to the underlying VM
                                          type: string
                                      type: object
                                    type: array
                                  allowedInstanceTypes:
                                    description: The AWS instance types that are allowed
                                      by the upstream nodepool definition
                                    items:
                                      type: string
                                    type: array
                                  availabilityZones:
                                    description: The availability zones associated
                                      with this target
                                    items:
                                      type: string
                                    type: array
                                  iamInstanceProfileArn:
                                    description: The IAM instance profile to be used
                                      for the underlying VMs
                                    type: string
                                  imdsMaxHopCount:
                                    description: The IMDS max hop count to be used
                                      for the underlying VMs
                                    format: int32
                                    type: integer
                                  imdsVersion:
                                    description: The IMDS version to be used for the
                                      underlying VMs
                                    type: string
                                  securityGroupIds:
                                    description: The security groups associated with
                                      this target
                                    items:
                                      type: string
                                    type: array
                                  subnets:
                                    description: |-
                                      The AWS key pair to be used for the underlying VMs
                                      The tags associated with this target
                                      TemplateTags     map[string]string `json:"templateTags,omitempty"`
                                      The active AWS subnets for this target
                                    items:
                                      type: string
                                    type: array
                                type: object
                            type: object
                          type:
                            description: The type of the target
                            enum:
                            - ClusterAutoscalerASG
                            - KarpenterNodepoolB1
                            - KarpenterNodepoolV1
                            - SpotVNG
                            - StaticNodegroup
                            - CastAINodeTemplate
                            type: string
                          upstreamCloudName:
                            description: Upstream cloud name
                            type: string
                        required:
                        - type
                        type: object
                    required:
                    - target
                    type: object
                required:
                - spec
                type: object
              qNodeStatuses:
                description: Number of QNodes per phase
                items:
                  properties:
                    count:
                      type: integer
                    phase:
                      enum:
                      - Initializing
                      - OnHold
                      - Baking
                      - RequestingHibernation
                      - Hibernating
                      - Hibernated
                      - RequestingResume
                      - Resuming
                      - Running
                      - RequiresUpdate
                      - RequestingCacheUpdate
                      - UpdatingCache
                      - Draining
                      - Terminating
                      type: string
                  required:
                  - count
                  - phase
                  type: object
                type: array
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
